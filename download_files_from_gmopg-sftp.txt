@startuml download_files_from_gmopg-sftp
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
participant fetch
participant GMOPGInteractor
participant SFTPClient
participant ValidateMD5Checksum
participant GCSInteractor
database "/tmp" as tmp
database SFTPServer
database GCSBucket
database Spanner
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

activate fetch  #FFBBBB
alt スキップフラグがTrueかどうか
    note right of fetch: ローカルテスト時、SFTPServerを利用しないため処理をスキップする
    fetch -> fetch: 処理を終了
    return コマンド引数の`localRequestFilePath`フラグで指定された\nローカルの「有効性チェック依頼ファイル」返却
else
    fetch --> fetch: 処理続行
end
fetch -> Spanner: fetchフェーズ"開始"レコード挿入
create GMOPGInteractor
fetch -> GMOPGInteractor

'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
activate GMOPGInteractor #BBFFFF
loop 2(「有効性チェック依頼ファイル」、「MD5 checksum」)
    GMOPGInteractor -> GMOPGInteractor: ファイルパス生成
    note right of GMOPGInteractor: ファイルパスは"SFTPリモートパス"と"ローカルdstパス"を含む
    create SFTPClient
    GMOPGInteractor -> SFTPClient
    activate SFTPClient #BBFFBB
    note right of GMOPGInteractor: dstファイルパス:\n""- 有効性チェック依頼ファイル:/tmp/merp_recurringfile_req_YYYYMMDD""\n""- MD5 checksum:/tmp/merp_recurringfile_req_YYYYMMDD.md5""
    SFTPClient -> tmp: dstファイル新規作成
    SFTPClient -> SFTPServer: リモートファイル取得
    SFTPClient -> SFTPClient: ファイル内容をdstファイルに書き込む
    return dstファイルパスを返却
    deactivate SFTPClient
end
alt SFTPServerファイル取得時のエラーが１つ以上存在する
    GMOPGInteractor --> fetch: エラーを返却
else
    GMOPGInteractor --> fetch: 「有効性チェック依頼ファイル」、「MD5 checksum」のdstファイルパス返却、処理続行
end
deactivate GMOPGInteractor
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''

fetch -> ValidateMD5Checksum
note right of ValidateMD5Checksum: 「有効性チェック依頼ファイル」破損チェック
activate ValidateMD5Checksum #E1BBFF
ValidateMD5Checksum -> tmp: 「有効性チェック依頼ファイル」、「MD5 checksum」をローカルから取得し、Open
ValidateMD5Checksum -> ValidateMD5Checksum:「有効性チェック依頼ファイル」のMD5 checksumを計算
ValidateMD5Checksum -> ValidateMD5Checksum: 計算したchecksumと「MD5 checksum」の照合を行う
alt checksumが異なる
    ValidateMD5Checksum --> fetch: エラーを返却
else
    ValidateMD5Checksum --> fetch: 処理続行
end
deactivate ValidateMD5Checksum

create GCSInteractor
fetch -> GCSInteractor
activate GCSInteractor #FFFFBB
GCSInteractor -> tmp: 「有効性チェック依頼ファイル」をローカルから取得し、Open
GCSInteractor -> GCSInteractor: GCSオブジェクトパスを生成、「cardvaliditycheck/request/dt=YYYY-MM-DD/merp_recurringfile_req_YYYYMMDD」
GCSInteractor -> GCSBucket: アップロード
return
deactivate GCSInteractor

fetch -> Spanner: fetchフェーズ"終了"レコード挿入

deactivate fetch

@enduml